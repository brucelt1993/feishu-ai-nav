# 飞书机器人服务设计方案

> 共创时间：2026-01-05
> 状态：✅ 已确认，准备实施

## 确认决策
- 服务名称：**bot-pilot**
- 权限控制：**全员可查**
- OpenAI模型：**gpt-4o**
- MCP工具：**10个**（原8个 + 留存分析 + 时段分布）

---

## 一、服务命名

推荐名称：**`bot-pilot`** (导航领航员)

**命名理由**：
- `pilot` = 领航员/飞行员，契合飞书(飞)和导航(Nav)的主题
- 简洁好记，符合命名规范
- 暗示 AI 助手的引导角色

备选方案：
- `aibot-server` - 直白但缺乏特色
- `navibot` - 导航机器人，稍显平淡
- `stella` - 星星/向导，偏抽象

---

## 二、核心架构设计

### 2.1 目录结构

```
feishu-ai-nav/
├── backend/                    # 现有后端 (FastAPI)
├── frontend/                   # 现有前端 (Vue3)
└── bot-pilot/                  # 新增：机器人服务
    ├── app/
    │   ├── main.py             # 应用入口
    │   ├── config.py           # 配置管理
    │   ├── api/
    │   │   ├── callback.py     # 飞书事件回调 (Webhook)
    │   │   └── health.py       # 健康检查
    │   ├── core/
    │   │   ├── bot.py          # 机器人核心类
    │   │   ├── event_handler.py    # 事件处理器
    │   │   ├── message_handler.py  # 消息处理器
    │   │   └── command_parser.py   # 命令解析器
    │   ├── llm/
    │   │   ├── openai_client.py    # OpenAI 客户端
    │   │   ├── prompt_manager.py   # Prompt 管理
    │   │   └── mcp_tools.py        # MCP 工具定义
    │   ├── services/
    │   │   ├── stats_bridge.py     # 复用现有统计服务
    │   │   └── feishu_bridge.py    # 复用现有飞书服务
    │   ├── cards/
    │   │   ├── builder.py          # 卡片构建器
    │   │   ├── templates/          # 卡片模板
    │   │   │   ├── stats_overview.json
    │   │   │   ├── tool_ranking.json
    │   │   │   ├── user_ranking.json
    │   │   │   └── error.json
    │   │   └── components.py       # 卡片组件
    │   └── utils/
    │       ├── logger.py           # 日志
    │       └── validators.py       # 校验
    ├── tests/
    ├── pyproject.toml
    └── README.md
```

### 2.2 技术选型

| 组件 | 选型 | 说明 |
|------|------|------|
| Web框架 | FastAPI | 与现有后端一致，支持异步 |
| 飞书SDK | lark-oapi (官方) | 事件订阅 + 消息发送 |
| LLM | OpenAI API | GPT-4o / GPT-4o-mini |
| MCP | 自定义实现 | 基于 Function Calling |
| 数据库 | 复用现有 | PostgreSQL/SQLite |

---

## 三、功能模块详解

### 3.1 飞书机器人对接

**事件订阅配置**：
- 接收消息：`im.message.receive_v1`
- @机器人：通过 mention 字段判断
- 群聊/私聊：统一处理

**消息类型支持**：
- 文本消息 (text)
- 富文本消息 (post) - 可选
- 图片消息 (image) - 识别截图咨询

**触发方式**：
```
私聊：直接发消息触发
群聊：@机器人 + 消息内容
```

### 3.2 OpenAI 集成

**能力边界**：
- 仅回答 AI 导航应用相关问题
- 超出范围统一话术婉拒
- 支持多轮对话（上下文记忆）

**调用流程**：
```
用户消息 → 命令解析 →
  ├─ 命令类 → 直接执行对应能力
  └─ 问答类 → OpenAI (带 System Prompt)
           → MCP Tools 判断
           → 生成回复
```

### 3.3 MCP 工具能力 (运营数据查询)

**MCP Tools 列表（10个）**：

| Tool Name | 描述 | 示例触发 |
|-----------|------|---------|
| `get_overview` | 获取今日概览 | "今天数据怎么样" |
| `get_tool_ranking` | 工具排行榜 | "最热门的工具是什么" |
| `get_user_ranking` | 用户活跃榜 | "谁用得最多" |
| `get_trend` | 访问趋势 | "最近一周趋势" |
| `get_tool_detail` | 工具详情 | "ChatGPT 使用情况" |
| `get_feedback_summary` | 反馈汇总 | "最近有什么反馈" |
| `search_tools` | 搜索工具 | "有什么画图工具" |
| `get_category_stats` | 分类统计 | "哪个分类最受欢迎" |
| `get_retention_stats` | 用户留存分析 | "用户留存怎么样" |
| `get_hourly_distribution` | 时段分布 | "什么时间段访问最多" |

**MCP 实现方式**：
使用 OpenAI Function Calling，将工具定义为 functions：

```python
tools = [
    {
        "type": "function",
        "function": {
            "name": "get_overview",
            "description": "获取今日AI导航应用的数据概览，包括PV、UV、新增用户等",
            "parameters": {
                "type": "object",
                "properties": {},
                "required": []
            }
        }
    },
    # ... 更多工具
]
```

### 3.4 系统 Prompt 设计

```markdown
## 角色定义

你是「AI导航小助手」，一个专门服务于公司内部 AI 工具导航平台的智能助手。

## 核心职责

1. **工具咨询**：解答关于平台收录的 AI 工具的使用问题
2. **数据查询**：为运营同学提供平台使用数据（PV/UV/排行等）
3. **反馈收集**：记录用户对工具或平台的建议和问题

## 能力边界

✅ 可以回答：
- AI 导航平台的功能介绍
- 平台收录工具的基本信息和用途
- 平台使用数据和统计报表
- 如何收藏、点赞、提交反馈
- 工具推荐（基于分类和热度）

❌ 不回答：
- 与 AI 导航平台无关的问题
- 具体 AI 工具的技术实现细节
- 公司内部敏感信息
- 编程、写作等通用 AI 任务

## 拒绝话术

当用户问到能力边界之外的问题时，使用以下话术：

「抱歉，这个问题超出了我的服务范围。我是 AI 导航平台的专属小助手，
主要负责工具咨询和数据查询。如果你有 AI 工具相关的问题，随时可以问我！」

## 回复风格

- 语气：友好专业，略带活泼
- 长度：简洁为主，复杂问题适当展开
- 格式：善用表情和分段，增强可读性

## 上下文信息

当前平台数据：
- 平台名称：飞书 AI 工具导航
- 工具总数：{tool_count}
- 分类数量：{category_count}
- 今日访问：{today_pv} PV / {today_uv} UV
```

### 3.5 卡片消息设计

**数据类卡片统一风格**：
- 主题色：蓝色系 (#1677FF)
- 图标：使用飞书标准图标
- 布局：标题 + 数据块 + 操作按钮

**卡片类型**：

#### 1) 数据概览卡片
```
┌─────────────────────────────────────┐
│ 📊 今日数据概览                      │
├─────────────────────────────────────┤
│  访问量     新增用户     活跃工具     │
│   1,234      56          48         │
│  ↑12%       ↑8%        ↓2%         │
├─────────────────────────────────────┤
│ [查看详情]  [导出报表]  [刷新]       │
└─────────────────────────────────────┘
```

#### 2) 工具排行卡片
```
┌─────────────────────────────────────┐
│ 🏆 热门工具 TOP5                     │
├─────────────────────────────────────┤
│ 1. ChatGPT        🔥 2,345次        │
│ 2. Midjourney     🔥 1,876次        │
│ 3. Claude         🔥 1,654次        │
│ 4. Stable Diff    🔥 1,234次        │
│ 5. Copilot        🔥 987次          │
├─────────────────────────────────────┤
│ 📅 统计周期：近7天                   │
│ [更多排行] [切换周期]                │
└─────────────────────────────────────┘
```

#### 3) 用户排行卡片
```
┌─────────────────────────────────────┐
│ 👑 活跃用户 TOP5                     │
├─────────────────────────────────────┤
│ 1. 张三    💎 456次  最近: 5分钟前   │
│ 2. 李四    💎 389次  最近: 1小时前   │
│ 3. 王五    💎 345次  最近: 2小时前   │
│ ...                                 │
├─────────────────────────────────────┤
│ [查看全部]                           │
└─────────────────────────────────────┘
```

#### 4) 工具搜索结果卡片
```
┌─────────────────────────────────────┐
│ 🔍 搜索结果：画图工具                │
├─────────────────────────────────────┤
│ 🎨 Midjourney                       │
│    AI图像生成，支持文生图           │
│    [查看详情] [打开工具]            │
│ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ │
│ 🖼️ Stable Diffusion                 │
│    开源图像生成模型                  │
│    [查看详情] [打开工具]            │
├─────────────────────────────────────┤
│ 共找到 5 个相关工具                  │
└─────────────────────────────────────┘
```

---

## 四、数据流设计

### 4.1 消息处理流程

```
                    ┌──────────────┐
                    │  飞书服务器   │
                    └──────┬───────┘
                           │ POST /callback
                           ▼
                    ┌──────────────┐
                    │  事件解析    │
                    │ (签名验证)   │
                    └──────┬───────┘
                           │
           ┌───────────────┼───────────────┐
           ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │ URL验证事件 │ │  消息事件   │ │  其他事件   │
    └─────────────┘ └──────┬──────┘ └─────────────┘
                           │
                           ▼
                    ┌──────────────┐
                    │  命令解析    │
                    │ (意图识别)   │
                    └──────┬───────┘
                           │
           ┌───────────────┼───────────────┐
           ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │ 快捷命令    │ │ 数据查询    │ │ 自然对话    │
    │ /help      │ │ MCP Tools   │ │ OpenAI      │
    └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
           │               │               │
           └───────────────┼───────────────┘
                           ▼
                    ┌──────────────┐
                    │  回复构建    │
                    │ (卡片/文本)  │
                    └──────┬───────┘
                           │
                           ▼
                    ┌──────────────┐
                    │  发送消息    │
                    │ (飞书API)    │
                    └──────────────┘
```

### 4.2 MCP 工具调用流程

```
用户消息: "最近7天哪个工具最火"
           │
           ▼
    ┌──────────────┐
    │  OpenAI API  │
    │ (with tools) │
    └──────┬───────┘
           │ function_call: get_tool_ranking
           │ arguments: {"days": 7, "limit": 10}
           ▼
    ┌──────────────┐
    │  执行 Tool   │
    │ StatsService │
    └──────┬───────┘
           │ 返回数据
           ▼
    ┌──────────────┐
    │  OpenAI API  │
    │ (生成回复)   │
    └──────┬───────┘
           │
           ▼
    ┌──────────────┐
    │  卡片构建    │
    │ (排行榜)     │
    └──────────────┘
```

---

## 五、部署架构

### 5.1 独立服务部署

```
                    ┌─────────────────────────────────────┐
                    │           飞书开放平台               │
                    │    (机器人事件订阅 → Webhook)       │
                    └──────────────┬──────────────────────┘
                                   │
                    ┌──────────────▼──────────────────────┐
                    │           Nginx                      │
                    │    (反向代理 + SSL)                  │
                    └──────────────┬──────────────────────┘
                                   │
          ┌────────────────────────┼────────────────────────┐
          │                        │                        │
          ▼                        ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  bot-pilot      │    │  backend        │    │  frontend       │
│  :8001          │    │  :8000          │    │  :3000          │
│  (机器人服务)   │    │  (API服务)      │    │  (静态资源)     │
└────────┬────────┘    └────────┬────────┘    └─────────────────┘
         │                      │
         │    ┌─────────────────┤
         │    │                 │
         ▼    ▼                 ▼
    ┌─────────────────────────────────┐
    │           PostgreSQL            │
    │         (共享数据库)            │
    └─────────────────────────────────┘
```

### 5.2 端口规划

| 服务 | 端口 | 说明 |
|------|------|------|
| backend | 8000 | 现有API服务 |
| bot-pilot | 8001 | 机器人服务 |
| frontend | 3000 | 前端开发服务 |

---

## 六、配置项

### 6.1 新增环境变量

```bash
# bot-pilot/.env

# 飞书配置 (复用现有)
FEISHU_APP_ID=cli_xxx
FEISHU_APP_SECRET=xxx

# 飞书机器人特有配置
FEISHU_ENCRYPT_KEY=xxx           # 事件加密密钥
FEISHU_VERIFICATION_TOKEN=xxx    # 事件验证 Token

# OpenAI 配置
OPENAI_API_KEY=sk-xxx
OPENAI_BASE_URL=https://api.openai.com/v1  # 支持代理
OPENAI_MODEL=gpt-4o                         # 默认模型

# 数据库 (复用现有)
DATABASE_URL=postgresql://user:pass@localhost/feishu_nav

# 服务配置
BOT_PORT=8001
LOG_LEVEL=INFO
```

---

## 七、实现计划

### Phase 1：基础框架 (Day 1-2)
- [ ] 项目初始化 (目录结构、依赖)
- [ ] 飞书 SDK 集成 (事件订阅)
- [ ] 消息接收和回复基本链路
- [ ] 健康检查接口

### Phase 2：MCP 工具 (Day 3-4)
- [ ] 复用现有 StatsService
- [ ] 定义 MCP Tools Schema
- [ ] 实现工具调用桥接
- [ ] 测试数据查询能力

### Phase 3：OpenAI 集成 (Day 5-6)
- [ ] OpenAI 客户端封装
- [ ] System Prompt 实现
- [ ] Function Calling 集成
- [ ] 上下文记忆 (会话管理)

### Phase 4：卡片消息 (Day 7-8)
- [ ] 卡片模板设计
- [ ] 卡片构建器实现
- [ ] 各类卡片适配
- [ ] 交互按钮处理

### Phase 5：完善与部署 (Day 9-10)
- [ ] 错误处理和重试
- [ ] 日志和监控
- [ ] Docker 部署配置
- [ ] 文档编写

---

## 八、技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| OpenAI API 延迟 | 用户等待时间长 | 先发"思考中"提示 |
| 飞书事件重复推送 | 重复回复 | 事件去重 (message_id) |
| 并发请求过多 | 服务过载 | 请求队列 + 限流 |
| Token 过期 | 回复失败 | 自动刷新 + 重试 |

---

*文档版本：v1.0 - 初稿*
*待用户确认后开始实施*
